<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover">
<title>أداة مجانية لتحويل مختلف أنواع الصور الى WebP</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f7f8fb; --bg-2:#f1f5fb; --card:#ffffff; --text:#0c1424; --muted:#5b6472; --accent:#2563eb;
    --ok:#15803d; --warn:#d97706; --error:#dc2626; --border:#e6e9f2; --shadow:0 6px 16px rgba(0,0,0,.08);
    --radius:16px; --radius-sm:12px;
    --sidebar-w:280px;
    --fs-base:13px; --fs-sm:11.5px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Cairo",system-ui,Arial,Helvetica,sans-serif; line-height:1.65;
    background:linear-gradient(180deg,var(--bg),var(--bg-2)); color:var(--text);
    -webkit-font-smoothing:antialiased; overflow-x:hidden; font-size:var(--fs-base);
  }
  .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 64px}

  .topbar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .btn{
    border:1px solid var(--border); background:linear-gradient(180deg,#fff,#f9fbff);
    color:var(--text); padding:8px 12px; border-radius:14px; cursor:pointer; font-weight:700; box-shadow:var(--shadow);
    transition:transform .18s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
    font-size:12px; text-decoration:none; display:inline-flex; align-items:center; gap:6px;
  }
  .btn:hover{transform:translateY(-2px); border-color:#cbd5e1}
  .btn.home{background:#000; color:#fff; border-color:#000}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .btn.contactTop{
    background: var(--accent);
    border-color: var(--accent);
    color:#fff;
    justify-content:center;
  }
  .btn.contactTop:hover{ background: var(--accent); border-color: var(--accent); color:#fff; }

  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}
  .titleRow{display:flex;align-items:center;gap:10px;justify-content:space-between}
  h1{margin:0;font-size:clamp(18px,2.2vw,24px);font-weight:800;letter-spacing:.2px}
  .sub{margin-top:6px;color:var(--muted);font-size:var(--fs-sm)}
  .logo{width:100%; max-width:180px; align-self:center; object-fit:contain; object-position:center; background:#fff; border-radius:12px; border:1px solid var(--border); padding:8px}
  .title-logo{width:180px; max-width:180px; align-self:center}

  .layout{
    display:grid;
    grid-template-columns: var(--sidebar-w) minmax(0,1fr) minmax(0,1fr);
    grid-template-areas: "side uploads results";
    gap:14px;
    align-items:stretch;
    margin-top:12px;
  }

  #sidePanel{grid-area:side}
  #uploadsCard{grid-area:uploads}
  #resultsCard{grid-area:results}

  #sidePanel{display:flex; overflow:visible;}
  .sidebar-card{
    flex:1 1 auto;
    display:flex; flex-direction:column; gap:10px;
    height:100%;
    overflow:visible;
    min-height:0;
  }

  .avatar{width:112px;height:112px;border-radius:50%;background:#fff;padding:6px;object-fit:contain;object-position:center;border:1px solid var(--border);align-self:center}
  .s-list{display:grid; gap:8px}
  .s-item a{
    display:block; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:#fff;
    color:#0f172a; text-decoration:none; font-weight:600; transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    box-shadow:0 4px 12px rgba(15,23,42,.05); font-size:13px;
  }
  .s-item a:hover{transform:translateY(-2px); border-color:#cbd5e1; box-shadow:0 8px 18px rgba(15,23,42,.08)}
  .s-text{
    display:block; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:#fff;
    color:#0f172a; font-weight:600; box-shadow:0 4px 12px rgba(15,23,42,.05); font-size:13px;
  }

  .card.section{padding:16px; height:100%; min-height:0;}
  .label{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;font-weight:800;font-size:14px}
  .hint{font-size:12px;color:var(--muted)}

  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  button{padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.loading{opacity:.7;pointer-events:none}
  button.danger{background:#fff;border-color:#fecaca;color:#b91c1c}
  button.danger:hover{border-color:#fca5a5}

  .status{font-size:12px;margin-top:8px;display:flex;align-items:center;gap:8px}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.bad{color:var(--error)}
  .status.hidden{display:none}
  .err{margin-top:8px;font-size:12px;color:var(--error)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px;color:var(--muted);font-weight:800}

  .drop{
    border:1.5px dashed #cbd5e1;
    background:linear-gradient(180deg,#fff,#f9fbff);
    border-radius:14px;
    padding:14px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    transition:transform .18s ease, box-shadow .25s ease, border-color .25s ease;
    cursor:pointer; /* ✅ يخلي الضغط على المنطقة يفتح اختيار الملفات */
  }
  .drop.drag{border-color:var(--accent); box-shadow:0 0 0 4px rgba(37,99,235,.12)}
  .drop strong{font-size:13px}
  .drop .mini{font-size:12px;color:var(--muted)}

  .list{display:grid; gap:10px}
  .item{
    border:1px solid var(--border); border-radius:14px; background:#fff;
    padding:10px; display:grid; gap:10px;
    box-shadow:0 4px 12px rgba(15,23,42,.05);
  }
  .itemTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  .name{font-weight:900}
  .meta{color:var(--muted); font-size:12px; font-weight:800}
  .grid2{display:grid; grid-template-columns: 84px 1fr; gap:10px; align-items:center}
  .thumb{
    width:84px; height:84px; border-radius:12px; border:1px solid var(--border);
    background:#fff; object-fit:contain; object-position:center;
  }
  .bar{height:10px; border-radius:999px; background:#eef2ff; border:1px solid var(--border); overflow:hidden}
  .bar > i{display:block; height:100%; width:0%}
  .kpis{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .smallLink{
    border:1px solid var(--border); background:#fff; border-radius:12px; padding:8px 10px;
    text-decoration:none; font-weight:900; font-size:12px; display:inline-flex; gap:6px; align-items:center;
    box-shadow:0 4px 12px rgba(15,23,42,.05); color:#0f172a;
    transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .smallLink:hover{transform:translateY(-2px); border-color:#cbd5e1; box-shadow:0 8px 18px rgba(15,23,42,.08)}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--error)}

  @media (max-width:980px){
    .layout{
      grid-template-columns: 1fr;
      grid-template-areas:
        "uploads"
        "results"
        "side";
      align-items:stretch;
    }
    .avatar{width:104px;height:104px}
    .card.section{height:auto}
    .sidebar-card{height:auto}
    #sidePanel{display:block}
  }

  #modeInfo{display:none !important;}
</style>
</head>

<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <button class="btn" id="backBtn">رجوع</button>
      <a class="btn home" id="homeBtn" href="https://anasrashed.com" rel="noopener">الرئيسية</a>
      <a class="btn contactTop" id="contactTopBtn" href="https://contact.anasrashed.com" target="_blank" rel="noopener">تواصل معي</a>
    </div>

    <div class="card">
      <div class="titleRow">
        <div>
          <h1>أداة مجانية لتحويل مختلف أنواع الصور الى WebP</h1>
          <div class="sub">
            تحويل محلي 100% داخل المتصفح — بدون رفع ملفات. الجودة ثابتة 100%، والأداة تختار تلقائيًا أصغر نتيجة بين (Lossless) و (Lossy 100%).
          </div>
        </div>
        <img class="logo title-logo" src="https://i.imgur.com/meUEoP7.png" alt="الشعار"
             onerror="this.onerror=null; this.src='https://i.imgur.com/meUEoP7.jpg';">
      </div>
    </div>

    <div class="layout">

      <!-- السايدبار (يمين) -->
      <aside id="sidePanel">
        <div class="card sidebar-card">
          <img class="avatar" src="https://i.imgur.com/B3UkEQ0.jpg" alt="صورتي" referrerpolicy="no-referrer"
               onerror="this.onerror=null; this.src='https://i.imgur.com/B3UkEQ0.png';">

          <div class="s-list">
            <div class="s-item"><a href="https://whoami.anasrashed.com" target="_blank" rel="noopener">من أنا؟</a></div>
            <div class="s-item"><a href="https://anasrashed.gumroad.com/l/seo-book-for-ecommerce" target="_blank" rel="noopener">كتاب دليل السيو الشامل</a></div>
            <div class="s-item"><a href="https://blog.anasrashed.com" target="_blank" rel="noopener">المدونة</a></div>

            <div class="sub" style="text-align:center; font-size:18px; margin-top:10px;"><b>خدماتي</b></div>
            <div class="s-item"><span class="s-text">تحسين داخلي</span></div>
            <div class="s-item"><span class="s-text">تحسين خارجي</span></div>
            <div class="s-item"><span class="s-text">استخراج الكلمات المفتاحية للمنافسين</span></div>
            <div class="s-item"><span class="s-text">تفعيل خريطة الموقع للباقة بلس</span></div>

            <div class="sub" style="text-align:center; font-size:18px; margin-top:10px;"><b>أدوات سيو احترافية</b></div>
            <div class="s-item"><a href="https://serp.anasrashed.com" target="_blank" rel="noopener">أداة SERP بالذكاء الإصطناعي</a></div>
            <div class="s-item"><a href="https://writer.anasrashed.com" target="_blank" rel="noopener">أداة كتابة المقالات بالذكاء الإصطناعي</a></div>
            <div class="s-item"><a href="https://smg.anasrashed.com" target="_blank" rel="noopener">أداة منشئ خريطة الموقع</a></div>
            <div class="s-item"><a href="https://keywords.anasrashed.com" target="_blank" rel="noopener">أداة الكلمات المفتاحية</a></div>
            <div class="s-item"><a href="https://checker.anasrashed.com" target="_blank" rel="noopener">أداة فحص الموقع</a></div>
          </div>
        </div>
      </aside>

      <!-- رفع الصور (وسط) -->
      <section class="card section" id="uploadsCard">
        <div class="label">رفع الصور</div>

        <div class="drop" id="dropZone" role="button" aria-label="منطقة رفع الصور">
          <div>
            <strong>اسحب الصور هنا</strong>
            <div class="mini">أو اضغط هنا/على زر "اختيار ملفات" (يدعم: JPG / PNG / GIF / BMP / WebP).</div>
          </div>
          <div class="btns" style="margin:0">
            <button class="primary" id="pickBtn" type="button">اختيار ملفات</button>
          </div>
        </div>

        <!-- ✅ بدل hidden: display:none لتفادي مشاكل بعض البيئات -->
        <input id="fileInput" type="file" accept="image/*" multiple style="display:none">

        <div class="hint" style="margin-top:10px">
          ✅ الجودة ثابتة 100% دائمًا. الأداة تحاول تعطيك <b>أكبر توفير ممكن</b> عبر تجربة Lossless و Lossy-100 واختيار الأصغر تلقائيًا.
        </div>

        <div class="chips">
          <span class="chip" id="qualityChip">Quality: 100%</span>
          <span class="chip" id="engineChip">Engine: wasm-webp (libwebp) — لم يتم التحميل بعد</span>
          <span class="chip" id="countChip">0 ملفات</span>
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="primary" id="convertBtn" disabled>تحويل إلى WebP</button>
          <button id="zipBtn" disabled>تحميل الكل (ZIP)</button>
          <button class="danger" id="clearBtn">مسح</button>
        </div>

        <div id="status" class="status hidden"></div>
        <div id="err" class="err" hidden></div>

        <div class="hint" style="margin-top:12px">
          الخصوصية: يتم التحويل بالكامل داخل جهازك (بدون رفع أي ملفات).
        </div>
      </section>

      <!-- النتائج (يسار) -->
      <section class="card section" id="resultsCard">
        <div class="label">
          <span>النتائج</span>
          <span class="hint" id="summaryHint">—</span>
        </div>

        <div id="outList" class="list" style="margin-top:10px">
          <div class="hint">جاهز… ارفع صورك واضغط "تحويل".</div>
        </div>
      </section>

    </div>
  </div>

<!-- JSZip -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<!-- ✅ محرك WebP: module فقط (لو فشل، الرفع يظل شغال ونطلع رسالة واضحة) -->
<script type="module">
  try{
    const mod = await import("https://cdn.jsdelivr.net/npm/wasm-webp@0.0.2/dist/esm/index.js");
    window.__webp = { encoderVersion: mod.encoderVersion, encode: mod.encode };
    window.dispatchEvent(new Event('webp-engine-ready'));
  }catch(e){
    window.__webp = null;
    window.dispatchEvent(new Event('webp-engine-failed'));
  }
</script>

<!-- ✅ واجهة الرفع/السحب تعمل دائمًا (بدون module) -->
<script>
(() => {
  const $ = s => document.querySelector(s);

  const dropZone    = $('#dropZone');
  const fileInput   = $('#fileInput');
  const pickBtn     = $('#pickBtn');
  const convertBtn  = $('#convertBtn');
  const zipBtn      = $('#zipBtn');
  const clearBtn    = $('#clearBtn');

  const outList     = $('#outList');
  const statusEl    = $('#status');
  const errEl       = $('#err');
  const countChip   = $('#countChip');
  const engineChip  = $('#engineChip');
  const summaryHint = $('#summaryHint');

  const QUALITY = 100;

  let queue = [];
  let results = [];

  $('#backBtn').addEventListener('click', ()=>history.back());

  function setStatus(kind, msg){
    statusEl.className = 'status ' + (kind||'') + (msg ? '' : ' hidden');
    statusEl.textContent = msg || '';
  }
  function showErr(msg){
    errEl.hidden = false;
    errEl.textContent = msg;
  }
  function clearErr(){
    errEl.hidden = true;
    errEl.textContent = '';
  }

  function fmtBytes(n){
    const u = ['B','KB','MB','GB'];
    let i = 0, x = n;
    while(x >= 1024 && i < u.length-1){ x/=1024; i++; }
    return `${x.toFixed(i?1:0)} ${u[i]}`;
  }
  function pctSaved(inB, outB){
    if(!inB) return 0;
    return Math.round(((inB - outB) / inB) * 100);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function revokeAll(){
    for(const r of results){
      try{ URL.revokeObjectURL(r.url); }catch(e){}
      try{ URL.revokeObjectURL(r.thumbUrl); }catch(e){}
    }
  }

  function resetAll(){
    revokeAll();
    results = [];
    queue = [];
    outList.innerHTML = '<div class="hint">جاهز… ارفع صورك واضغط "تحويل".</div>';
    convertBtn.disabled = true;
    zipBtn.disabled = true;
    countChip.textContent = '0 ملفات';
    summaryHint.textContent = '—';
    setStatus('', '');
    clearErr();
    fileInput.value = '';
  }
  clearBtn.addEventListener('click', resetAll);

  function isSupportedImage(file){
    const t = (file.type || '').toLowerCase();
    if(t === 'image/svg+xml') return false;
    if(t.startsWith('image/')) return true;
    const name = (file.name || '').toLowerCase();
    return /\.(png|jpe?g|gif|bmp|webp|tiff|tif)$/i.test(name);
  }

  function addFiles(files){
    clearErr(); setStatus('', '');
    const arr = Array.from(files || []).filter(isSupportedImage);
    if(!arr.length){
      setStatus('warn','اختر صور فقط (PNG/JPG/GIF/BMP/WebP).');
      return;
    }
    queue.push(...arr);
    countChip.textContent = `${queue.length} ملفات`;
    convertBtn.disabled = queue.length === 0;
    renderPending();
  }

  function renderPending(){
    if(!queue.length){
      outList.innerHTML = '<div class="hint">جاهز… ارفع صورك واضغط "تحويل".</div>';
      summaryHint.textContent = '—';
      return;
    }
    summaryHint.textContent = `جاهز للتحويل: ${queue.length} صورة`;
    outList.innerHTML = queue.map((f)=>`
      <div class="item">
        <div class="itemTop">
          <div>
            <div class="name">${escapeHtml(f.name)}</div>
            <div class="meta">الحجم الأصلي: ${fmtBytes(f.size)} — النوع: ${escapeHtml(f.type || '—')}</div>
          </div>
          <div class="kpis"><span class="chip">بانتظار التحويل</span></div>
        </div>
        <div class="bar"><i style="width:0%"></i></div>
      </div>
    `).join('');
  }

  // ✅ فتح اختيار الملفات
  function openPicker(){
    try{ fileInput.click(); }catch(e){
      showErr('تعذر فتح اختيار الملفات. جرّب تحديث الصفحة.');
    }
  }

  pickBtn.addEventListener('click', (e)=>{ e.preventDefault(); openPicker(); });

  // ✅ الضغط على منطقة الرفع يفتح اختيار الملفات (يساعد الجوال)
  dropZone.addEventListener('click', (e)=>{
    // إذا ضغط على الزر نفسه لا نكرر
    if(e.target && (e.target.id === 'pickBtn' || e.target.closest('#pickBtn'))) return;
    openPicker();
  });

  fileInput.addEventListener('change', e => addFiles(e.target.files));

  // ✅ منع المتصفح من فتح الصورة بدل إسقاطها داخل الأداة
  ['dragover','drop'].forEach(ev=>{
    window.addEventListener(ev, (e)=>{ e.preventDefault(); }, { passive:false });
  });

  ['dragenter','dragover'].forEach(ev=>{
    dropZone.addEventListener(ev, (e)=>{
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.add('drag');
    }, { passive:false });
  });
  ['dragleave','drop'].forEach(ev=>{
    dropZone.addEventListener(ev, (e)=>{
      e.preventDefault(); e.stopPropagation();
      dropZone.classList.remove('drag');
    }, { passive:false });
  });
  dropZone.addEventListener('drop', (e)=>{
    addFiles(e.dataTransfer.files);
  }, { passive:false });

  function setUIBusy(isBusy){
    convertBtn.disabled = isBusy || queue.length === 0;
    pickBtn.disabled = isBusy;
    clearBtn.disabled = isBusy;
    zipBtn.disabled = isBusy || results.length === 0;

    if(isBusy){
      convertBtn.classList.add('loading');
      convertBtn.textContent = '... جاري التحويل';
    }else{
      convertBtn.classList.remove('loading');
      convertBtn.textContent = 'تحويل إلى WebP';
    }
  }

  function updateProgress(idx, pct, label){
    const item = outList.children[idx];
    if(!item) return;
    const bar = item.querySelector('.bar > i');
    if(bar) bar.style.width = `${pct}%`;
    const kpis = item.querySelector('.kpis');
    if(kpis && label){
      kpis.innerHTML = `<span class="chip">${escapeHtml(label)}</span>`;
    }
  }

  function hasAlpha(imgData){
    const d = imgData.data;
    for(let i=3; i<d.length; i+=4){
      if(d[i] !== 255) return true;
    }
    return false;
  }

  async function fileToImageData(file){
    if ('createImageBitmap' in window) {
      try{
        const bmp = await createImageBitmap(file, { imageOrientation: "from-image" });
        const canvas = document.createElement('canvas');
        canvas.width = bmp.width;
        canvas.height = bmp.height;
        const ctx = canvas.getContext('2d', { willReadFrequently:true });
        ctx.drawImage(bmp, 0, 0);
        const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
        try{ bmp.close && bmp.close(); }catch(e){}
        return { imgData, width: canvas.width, height: canvas.height };
      }catch(_){}
    }

    const url = URL.createObjectURL(file);
    try{
      const img = new Image();
      img.decoding = 'async';
      await new Promise((res, rej)=>{
        img.onload = ()=>res();
        img.onerror = ()=>rej(new Error("تعذر قراءة الصورة"));
        img.src = url;
      });

      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext('2d', { willReadFrequently:true });
      ctx.drawImage(img, 0, 0);

      const imgData = ctx.getImageData(0,0,w,h);
      return { imgData, width: w, height: h };
    } finally {
      try{ URL.revokeObjectURL(url); }catch(e){}
    }
  }

  async function encodeBest(imgData, width, height){
    if(!window.__webp || !window.__webp.encode){
      throw new Error('محرك التحويل لم يتم تحميله. تأكد أن المتصفح يسمح بتحميل ملفات js من jsdelivr.');
    }

    const alpha = hasAlpha(imgData);
    const data = imgData.data;
    const encode = window.__webp.encode;

    const [losslessBytes, lossyBytes] = await Promise.all([
      encode(data, width, height, alpha, { lossless: 1, quality: QUALITY }),
      encode(data, width, height, alpha, { lossless: 0, quality: QUALITY })
    ]);

    const ll = losslessBytes ? losslessBytes.length : Number.POSITIVE_INFINITY;
    const ly = lossyBytes ? lossyBytes.length : Number.POSITIVE_INFINITY;

    if(ly < ll) return { bytes: lossyBytes, chosen: 'Lossy (Quality 100)' };
    return { bytes: losslessBytes, chosen: 'Lossless' };
  }

  function renderResults(){
    if(!results.length){
      outList.innerHTML = '<div class="hint">لا توجد نتائج بعد.</div>';
      summaryHint.textContent = '—';
      return;
    }

    const totalIn  = results.reduce((a,r)=>a+r.inSize,0);
    const totalOut = results.reduce((a,r)=>a+r.outSize,0);
    const totalPct = pctSaved(totalIn, totalOut);

    summaryHint.innerHTML = `الإجمالي: ${fmtBytes(totalIn)} → ${fmtBytes(totalOut)} (توفير <b>${totalPct}%</b>)`;
    zipBtn.disabled = false;

    outList.innerHTML = results.map((r)=>`
      <div class="item">
        <div class="itemTop">
          <div>
            <div class="name">${escapeHtml(r.name)}</div>
            <div class="meta">
              ${r.w}×${r.h} — ${escapeHtml(r.modeChosen)} — ${fmtBytes(r.inSize)} → ${fmtBytes(r.outSize)}
              <span class="${r.savedPct>=25?'ok':(r.savedPct>=5?'warn':'')}"> (توفير ${r.savedPct}%)</span>
            </div>
          </div>
          <div class="kpis">
            <a class="smallLink" download="${escapeHtml(r.name)}" href="${r.url}">تحميل WebP</a>
            <span class="chip">${fmtBytes(r.outSize)}</span>
          </div>
        </div>

        <div class="grid2">
          <img class="thumb" src="${r.thumbUrl}" alt="">
          <div>
            <div class="bar"><i style="width:100%"></i></div>
            <div class="hint" style="margin-top:8px">تم التحويل محليًا داخل المتصفح.</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  async function convertAll(){
    clearErr();
    setStatus('', '');
    if(!queue.length){ setStatus('warn','ارفع صور أولاً.'); return; }

    setUIBusy(true);
    setStatus('warn','جاري التحويل… لا تغلق الصفحة.');

    try{
      // تحديث اسم المحرك إن توفر
      try{
        if(window.__webp && window.__webp.encoderVersion){
          const ver = await window.__webp.encoderVersion();
          engineChip.textContent = `Engine: wasm-webp (libwebp ${ver})`;
        }
      }catch(_){}

      outList.innerHTML = queue.map((f)=>`
        <div class="item">
          <div class="itemTop">
            <div>
              <div class="name">${escapeHtml(f.name)}</div>
              <div class="meta">الحجم الأصلي: ${fmtBytes(f.size)} — ${escapeHtml(f.type || '—')}</div>
            </div>
            <div class="kpis"><span class="chip">0%</span></div>
          </div>
          <div class="bar"><i style="width:0%"></i></div>
        </div>
      `).join('');

      results = [];

      for(let i=0; i<queue.length; i++){
        const file = queue[i];

        updateProgress(i, 10, 'قراءة…');
        const { imgData, width, height } = await fileToImageData(file);

        updateProgress(i, 60, 'تحويل…');
        const { bytes, chosen } = await encodeBest(imgData, width, height);

        const blob = new Blob([bytes], { type:'image/webp' });
        const outName = (file.name || 'image')
          .replace(/\.(png|jpg|jpeg|gif|bmp|webp|tiff|tif)$/i,'') + '.webp';

        const url = URL.createObjectURL(blob);
        const thumbUrl = URL.createObjectURL(file);

        const saved = pctSaved(file.size, blob.size);

        results.push({
          name: outName,
          inSize: file.size,
          outSize: blob.size,
          savedPct: saved,
          blob,
          url,
          modeChosen: chosen,
          w: width,
          h: height,
          thumbUrl
        });

        updateProgress(i, 100, 'تم');
      }

      queue = [];
      countChip.textContent = '0 ملفات';
      convertBtn.disabled = true;

      renderResults();
      setStatus('ok','تم التحويل بنجاح.');
    }catch(e){
      setStatus('bad','فشل التحويل.');
      showErr('خطأ: ' + String(e && e.message ? e.message : e));
    }finally{
      setUIBusy(false);
    }
  }

  convertBtn.addEventListener('click', convertAll);

  zipBtn.addEventListener('click', async ()=>{
    clearErr(); setStatus('', '');
    if(!results.length) return;

    try{
      setUIBusy(true);
      setStatus('warn','جاري تجهيز ZIP…');

      const zip = new JSZip();
      const folder = zip.folder('webp');
      for(const r of results){
        folder.file(r.name, r.blob);
      }

      const zipBlob = await zip.generateAsync({ type:'blob' });
      const zipUrl = URL.createObjectURL(zipBlob);

      const a = document.createElement('a');
      a.href = zipUrl;
      a.download = 'webp-images.zip';
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(()=>{ try{ URL.revokeObjectURL(zipUrl); }catch(e){} }, 3000);
      setStatus('ok','تم تحميل ZIP.');
    }catch(e){
      setStatus('bad','تعذر إنشاء ZIP.');
      showErr('خطأ: ' + String(e && e.message ? e.message : e));
    }finally{
      setUIBusy(false);
    }
  });

  // رسائل واضحة لحالة المحرك
  window.addEventListener('webp-engine-ready', ()=>{
    engineChip.textContent = 'Engine: wasm-webp (libwebp) — تم التحميل';
  });
  window.addEventListener('webp-engine-failed', ()=>{
    engineChip.textContent = 'Engine: wasm-webp — فشل التحميل';
    setStatus('warn','ملاحظة: الرفع شغال، لكن محرك التحويل ما قدر يحمّل من jsdelivr.');
  });

  resetAll();
})();
</script>
</body>
</html>
